name: Deploy to Production

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd /home/edouard/claude-telegram-relay
            git fetch origin master
            git checkout master
            git pull origin master

            # Install deps if package.json changed
            if git diff --name-only HEAD~1 HEAD | grep -q "package.json"; then
              bun install
            fi

            # Restart services
            npx pm2 restart claude-relay --update-env
            npx pm2 restart claude-dashboard --update-env

            # Smoke test: wait for services to start, then check health
            sleep 5
            RELAY_STATUS=$(npx pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="claude-relay") | .pm2_env.status')
            DASHBOARD_STATUS=$(npx pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="claude-dashboard") | .pm2_env.status')
            HEALTH=$(curl -sf http://localhost:3456/api/health | jq -r '.status' 2>/dev/null || echo "unreachable")

            if [ "$RELAY_STATUS" != "online" ] || [ "$HEALTH" != "ok" ]; then
              echo "SMOKE TEST FAILED: relay=$RELAY_STATUS dashboard=$DASHBOARD_STATUS health=$HEALTH"
              bash /home/edouard/claude-telegram-relay/scripts/notify-deploy.sh "failure" "Smoke test failed: relay=$RELAY_STATUS health=$HEALTH"
              exit 1
            fi

            COMMIT=$(git log --oneline -1)
            echo "Deploy complete: $COMMIT (smoke test OK)"

            # Notify serveur topic
            bash /home/edouard/claude-telegram-relay/scripts/notify-deploy.sh "success" "$COMMIT"
