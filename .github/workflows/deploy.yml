name: Deploy to Production

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd /home/edouard/claude-telegram-relay
            git fetch origin master
            git checkout master
            git pull origin master

            # Install deps if package.json changed
            if git diff --name-only HEAD~1 HEAD | grep -q "package.json"; then
              bun install
            fi

            # Restart services
            npx pm2 restart claude-relay --update-env
            npx pm2 restart claude-dashboard --update-env

            echo "Deploy complete: $(git log --oneline -1)"
