<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backlog — Claude Relay</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --yellow: #d29922;
      --red: #f85149;
      --purple: #bc8cff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .sprint-info {
      color: var(--text-muted);
      font-size: 14px;
    }

    .sprint-info strong {
      color: var(--accent);
    }

    .filters {
      display: flex;
      gap: 8px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      align-items: center;
      flex-wrap: wrap;
    }

    .filters label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 4px;
    }

    .filter-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .filter-btn:hover {
      border-color: var(--accent);
      color: var(--text);
    }

    .filter-btn.active {
      background: rgba(88, 166, 255, 0.15);
      border-color: var(--accent);
      color: var(--accent);
    }

    .stats {
      display: flex;
      gap: 24px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
    }

    .stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value.green { color: var(--green); }
    .stat-value.blue { color: var(--accent); }
    .stat-value.yellow { color: var(--yellow); }
    .stat-value.muted { color: var(--text-muted); }

    .board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      padding: 24px;
      min-height: calc(100vh - 200px);
    }

    .column {
      background: var(--surface);
      border-radius: 8px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }

    .column-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .column-header h2 {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .column-count {
      background: var(--border);
      color: var(--text-muted);
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .column-body {
      padding: 8px;
      flex: 1;
      overflow-y: auto;
    }

    .card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: default;
      transition: border-color 0.15s;
    }

    .card:hover {
      border-color: var(--accent);
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .card-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .priority-1 { background: var(--red); color: #fff; }
    .priority-2 { background: var(--yellow); color: #000; }
    .priority-3 { background: var(--border); color: var(--text-muted); }
    .priority-4 { background: var(--border); color: var(--text-muted); }
    .priority-5 { background: var(--border); color: var(--text-muted); }

    .project-tag {
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent);
    }

    .sprint-tag {
      background: rgba(188, 140, 255, 0.15);
      color: var(--purple);
    }

    .card-id {
      font-size: 11px;
      color: var(--text-muted);
      font-family: monospace;
    }

    .card-desc {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
      line-height: 1.4;
    }

    .empty-state {
      color: var(--text-muted);
      font-size: 13px;
      text-align: center;
      padding: 32px 16px;
    }

    .status-bar {
      padding: 8px 24px;
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
    }

    .col-backlog .column-header { border-top: 3px solid var(--text-muted); }
    .col-in_progress .column-header { border-top: 3px solid var(--accent); }
    .col-review .column-header { border-top: 3px solid var(--yellow); }
    .col-done .column-header { border-top: 3px solid var(--green); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* PRD view */
    .prd-view { display: none; padding: 24px; }
    .prd-view.visible { display: block; }

    .prd-list { display: flex; flex-direction: column; gap: 12px; }

    .prd-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .prd-card:hover { border-color: var(--accent); }

    .prd-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .prd-card-title { font-size: 16px; font-weight: 600; }

    .prd-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .prd-status-draft { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }
    .prd-status-approved { background: rgba(63, 185, 80, 0.2); color: var(--green); }
    .prd-status-rejected { background: rgba(248, 81, 73, 0.2); color: var(--red); }
    .prd-status-superseded { background: rgba(210, 153, 34, 0.2); color: var(--yellow); }

    .prd-card-summary {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .prd-card-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 12px;
    }

    .prd-detail {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      margin-top: 16px;
    }

    .prd-detail.visible { display: block; }

    .prd-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .prd-detail-back {
      color: var(--accent);
      cursor: pointer;
      font-size: 13px;
    }

    .prd-detail-content {
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
      color: var(--text);
    }

    .prd-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 48px 24px;
      font-size: 14px;
    }

    @media (max-width: 900px) {
      .board {
        grid-template-columns: 1fr;
      }
      .stats { flex-wrap: wrap; gap: 16px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Claude Relay — Backlog</h1>
    <div class="sprint-info" id="sprint-info">Chargement...</div>
  </header>
  <div class="tabs">
    <div class="tab active" data-tab="kanban" onclick="switchTab('kanban')">Kanban</div>
    <div class="tab" data-tab="prds" onclick="switchTab('prds')">PRDs</div>
  </div>
  <div id="kanban-view">
  <div class="filters" id="filters">
    <label>Sprint:</label>
    <button class="filter-btn active" data-sprint="all">Tous</button>
  </div>
  <div class="stats" id="stats">
    <div class="stat"><span class="stat-value muted" id="stat-total">-</span><span class="stat-label">Total</span></div>
    <div class="stat"><span class="stat-value blue" id="stat-active">-</span><span class="stat-label">En cours</span></div>
    <div class="stat"><span class="stat-value green" id="stat-done">-</span><span class="stat-label">Fait</span></div>
    <div class="stat"><span class="stat-value yellow" id="stat-pct">-</span><span class="stat-label">Avancement</span></div>
  </div>
  <div class="board" id="board">
    <div class="column col-backlog">
      <div class="column-header"><h2>A faire</h2><span class="column-count" id="count-backlog">0</span></div>
      <div class="column-body" id="col-backlog"></div>
    </div>
    <div class="column col-in_progress">
      <div class="column-header"><h2>En cours</h2><span class="column-count" id="count-in_progress">0</span></div>
      <div class="column-body" id="col-in_progress"></div>
    </div>
    <div class="column col-review">
      <div class="column-header"><h2>Review</h2><span class="column-count" id="count-review">0</span></div>
      <div class="column-body" id="col-review"></div>
    </div>
    <div class="column col-done">
      <div class="column-header"><h2>Fait</h2><span class="column-count" id="count-done">0</span></div>
      <div class="column-body" id="col-done"></div>
    </div>
  </div>
  <div class="status-bar" id="status-bar"></div>
  </div>

  <div class="prd-view" id="prd-view">
    <div id="prd-list-container" class="prd-list"></div>
    <div id="prd-detail-container" class="prd-detail">
      <div class="prd-detail-header">
        <span class="prd-detail-back" onclick="showPRDList()">&larr; Retour</span>
        <span id="prd-detail-status" class="prd-status"></span>
      </div>
      <div id="prd-detail-content" class="prd-detail-content"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = '__SUPABASE_URL__';
    const SUPABASE_KEY = '__SUPABASE_KEY__';

    const API = `${SUPABASE_URL}/rest/v1`;
    const HEADERS = {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
    };

    let allTasks = [];
    let activeSprint = 'all';

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function createCard(task) {
      const card = document.createElement('div');
      card.className = 'card';

      let meta = `<span class="tag priority-${task.priority}">P${task.priority}</span>`;
      meta += `<span class="tag project-tag">${escapeHtml(task.project)}</span>`;
      if (task.sprint) meta += `<span class="tag sprint-tag">${escapeHtml(task.sprint)}</span>`;
      meta += `<span class="card-id">${escapeHtml(task.id.substring(0, 8))}</span>`;

      let desc = '';
      if (task.description) {
        const truncated = task.description.substring(0, 120);
        desc = `<div class="card-desc">${escapeHtml(truncated)}${task.description.length > 120 ? '...' : ''}</div>`;
      }

      card.innerHTML = `
        <div class="card-title">${escapeHtml(task.title)}</div>
        <div class="card-meta">${meta}</div>
        ${desc}
      `;
      return card;
    }

    function renderBoard(tasks) {
      const filtered = activeSprint === 'all'
        ? tasks
        : tasks.filter(t => t.sprint === activeSprint);

      const columns = { backlog: [], in_progress: [], review: [], done: [] };
      for (const t of filtered) {
        if (columns[t.status]) columns[t.status].push(t);
      }

      for (const [status, items] of Object.entries(columns)) {
        const col = document.getElementById(`col-${status}`);
        const count = document.getElementById(`count-${status}`);
        col.innerHTML = '';
        count.textContent = items.length;

        if (items.length === 0) {
          col.innerHTML = '<div class="empty-state">Aucune tache</div>';
        } else {
          for (const t of items) {
            col.appendChild(createCard(t));
          }
        }
      }

      // Stats
      const total = filtered.length;
      const done = filtered.filter(t => t.status === 'done').length;
      const active = filtered.filter(t => t.status === 'in_progress').length;
      const pct = total > 0 ? Math.round((done / total) * 100) : 0;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-active').textContent = active;
      document.getElementById('stat-done').textContent = done;
      document.getElementById('stat-pct').textContent = `${pct}%`;
    }

    function renderFilters(tasks) {
      const sprints = [...new Set(tasks.map(t => t.sprint).filter(Boolean))].sort();
      const container = document.getElementById('filters');

      // Keep the label and "Tous" button, remove old sprint buttons
      const existingBtns = container.querySelectorAll('[data-sprint]:not([data-sprint="all"])');
      existingBtns.forEach(b => b.remove());

      for (const sprint of sprints) {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (activeSprint === sprint ? ' active' : '');
        btn.dataset.sprint = sprint;
        btn.textContent = sprint;
        btn.onclick = () => {
          activeSprint = sprint;
          updateFilterButtons();
          renderBoard(allTasks);
        };
        container.appendChild(btn);
      }

      // Update "Tous" button state
      const allBtn = container.querySelector('[data-sprint="all"]');
      allBtn.className = 'filter-btn' + (activeSprint === 'all' ? ' active' : '');
      allBtn.onclick = () => {
        activeSprint = 'all';
        updateFilterButtons();
        renderBoard(allTasks);
      };
    }

    function updateFilterButtons() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.className = 'filter-btn' + (btn.dataset.sprint === activeSprint ? ' active' : '');
      });
    }

    async function loadTasks() {
      try {
        const res = await fetch(
          `${API}/tasks?status=neq.cancelled&order=priority.asc,created_at.asc`,
          { headers: HEADERS }
        );
        allTasks = await res.json();

        renderFilters(allTasks);
        renderBoard(allTasks);

        // Sprint info
        const activeTasks = allTasks.filter(t => t.status !== 'done' && t.sprint);
        const sprints = [...new Set(activeTasks.map(t => t.sprint))];
        const sprintInfo = document.getElementById('sprint-info');
        if (sprints.length > 0) {
          const done = allTasks.filter(t => t.status === 'done' && sprints.includes(t.sprint)).length;
          const total = allTasks.filter(t => sprints.includes(t.sprint)).length;
          sprintInfo.innerHTML = `Sprint actif: <strong>${sprints.join(', ')}</strong> &mdash; ${done}/${total} fait`;
        } else {
          sprintInfo.textContent = `${allTasks.length} taches au total`;
        }

        document.getElementById('status-bar').textContent = `Mis a jour: ${new Date().toLocaleTimeString('fr-FR')}`;
      } catch (err) {
        console.error('Load error:', err);
        document.getElementById('status-bar').textContent = `Erreur: ${err.message}`;
      }
    }

    // ── Tabs ───────────────────────────────────────────────────

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      document.getElementById('kanban-view').style.display = tab === 'kanban' ? '' : 'none';
      const prdView = document.getElementById('prd-view');
      prdView.style.display = tab === 'prds' ? 'block' : 'none';
      if (tab === 'prds') loadPRDs();
    }

    // ── PRDs ──────────────────────────────────────────────────

    let allPRDs = [];

    const PRD_STATUS_LABELS = {
      draft: 'Brouillon',
      approved: 'Approuve',
      rejected: 'Rejete',
      superseded: 'Remplace',
    };

    function createPRDCard(prd) {
      const card = document.createElement('div');
      card.className = 'prd-card';
      card.onclick = () => showPRDDetail(prd);

      const date = new Date(prd.created_at).toLocaleDateString('fr-FR');
      const statusLabel = PRD_STATUS_LABELS[prd.status] || prd.status;

      card.innerHTML = `
        <div class="prd-card-header">
          <span class="prd-card-title">${escapeHtml(prd.title)}</span>
          <span class="prd-status prd-status-${prd.status}">${statusLabel}</span>
        </div>
        ${prd.summary ? `<div class="prd-card-summary">${escapeHtml(prd.summary)}</div>` : ''}
        <div class="prd-card-meta">
          <span>${escapeHtml(prd.project)}</span>
          <span>v${prd.version}</span>
          <span>${date}</span>
          <span style="font-family: monospace">${prd.id.substring(0, 8)}</span>
        </div>
      `;
      return card;
    }

    function showPRDDetail(prd) {
      document.getElementById('prd-list-container').style.display = 'none';
      const detail = document.getElementById('prd-detail-container');
      detail.classList.add('visible');

      const statusLabel = PRD_STATUS_LABELS[prd.status] || prd.status;
      document.getElementById('prd-detail-status').className = `prd-status prd-status-${prd.status}`;
      document.getElementById('prd-detail-status').textContent = statusLabel;

      const header = `${escapeHtml(prd.title)}\nProjet: ${escapeHtml(prd.project)} | v${prd.version} | ID: ${prd.id.substring(0, 8)}\n${'─'.repeat(60)}\n\n`;
      document.getElementById('prd-detail-content').textContent = header + (prd.content || '');
    }

    function showPRDList() {
      document.getElementById('prd-list-container').style.display = '';
      document.getElementById('prd-detail-container').classList.remove('visible');
    }

    async function loadPRDs() {
      try {
        const res = await fetch(
          `${API}/prds?order=created_at.desc`,
          { headers: HEADERS }
        );
        allPRDs = await res.json();

        const container = document.getElementById('prd-list-container');
        container.innerHTML = '';

        if (allPRDs.length === 0) {
          container.innerHTML = '<div class="prd-empty">Aucun PRD. Utilise /prd dans Telegram pour en creer un.</div>';
          return;
        }

        for (const prd of allPRDs) {
          container.appendChild(createPRDCard(prd));
        }
      } catch (err) {
        console.error('PRD load error:', err);
      }
    }

    // Initial load + auto-refresh every 30s
    loadTasks();
    setInterval(loadTasks, 30000);
  </script>
</body>
</html>
